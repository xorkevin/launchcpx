#!/usr/bin/env bash

set -e

if [ -z $FLIGHTCTL_ROOT ]; then
  echo "Run flightctl"
  exit 1
fi

. "${FLIGHTCTL_ROOT}/_flightctl_lib.sh"

usage() {
  cat <<EOF 1>&2
USAGE:
    $BIN_NAME [OPTIONS] <name>

OPTIONS:
    -n <namespace>
        Use the kubernetes namespace.
        Default is default.
    -t <ttl>
        Time to live duration of vault access tokens.
        Default is 1h.
    -m <maxttl>
        Max time to live duration of vault access tokens.
        Default is 24h.
    -f
        Force reregister with vault even if already registered.
    -d
        Deregister role.
    -h
        Print this help.

ARGS:
    <name>
        The name of the postgres service.
EOF
}

usage_exit() {
  usage
  exit 2
}

ns='default'
ttl='1h'
maxttl='24h'
name=
force=
deregister=

while getopts ':n:t:m:fdh' opt; do
  case $opt in
    n) ns="$OPTARG";;
    t) ttl="$OPTARG";;
    m) maxttl="$OPTARG";;
    f) force="1";;
    d) deregister="1";;
    h) usage; exit 0;;
    *) usage_exit;;
  esac
done
shift $(($OPTIND - 1))
name="$1"

# validation
if [ -z $name ]; then
  usage_exit
fi

svcname=${name}-postgres
config=${ns}-${name}
role=${config}-role
rolereadonly=${config}-readonly

if [ ! -z $deregister ]; then
  vault delete database/config/${config}
  vault delete database/roles/${role}
  vault delete database/roles/${rolereadonly}
  exit 0
fi

secret=$(kubectl -n $ns get sts/${svcname} -o=json | jq -r '.spec.template.spec.containers[].env[] | select(.name == "POSTGRES_PASSWORD") | .valueFrom.secretKeyRef.name')
password=$(kubectl -n $ns get secrets/${secret} -o=json | jq -r '.data["password"]' | base64 -d)

if [ -z $force ] && (vault read database/config/${config} >/dev/null 2>&1); then
  echo "Already registered ${config} with vault" 1>&2
  exit 1
fi

vault write database/config/${config} \
  plugin_name="postgresql-database-plugin" \
  allowed_roles="${role}" \
  connection_url="postgresql://{{username}}:{{password}}@${svcname}.${ns}.svc.cluster.local:5432/postgres?sslmode=disable" \
  username="postgres" \
  password="${password}"

vault write database/roles/${role} \
  db_name="${config}" \
  creation_statements="@${FLIGHTCTL_ROOT}/data/postgres/rolecreate.sql" \
  revocation_statements="@${FLIGHTCTL_ROOT}/data/postgres/rolerevoke.sql" \
  default_ttl="${ttl}" \
  max_ttl="${maxttl}"

vault write database/roles/${rolereadonly} \
  db_name="${config}" \
  creation_statements="@${FLIGHTCTL_ROOT}/data/postgres/rolereadonlycreate.sql" \
  revocation_statements="@${FLIGHTCTL_ROOT}/data/postgres/rolerevoke.sql" \
  default_ttl="${ttl}" \
  max_ttl="${maxttl}"
